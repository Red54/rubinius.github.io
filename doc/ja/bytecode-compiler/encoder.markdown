---
layout: doc_ja
title: Encoder Stage
previous: Generator Stage
previous_url: bytecode-compiler/generator
next: Packager Stage
next_url: bytecode-compiler/packager
---

ジェネレータがASTを処理し終えたら、
バイトコードを適切にエンコードする必要があります。
このステージはとてもシンプルで、ほとんどの処理は記録保持のために行われます。

エンコーダは２つのことを担当します：

* 前段階で（ASTノードの`bytecode`メソッドを呼んで）作成された命令のストリーム
  を命令列オブジェクトに変換します。
* スタックがアンダーフローしていないこと、オーバーフローしていないこと、
  そして正しく使われていること、を検証します。

これらの処理はメインのGeneratorオブジェクトについて実行され、さらにその全ての
子ジェネレータ（メインのオブジェクト内のブロックやメソッド等のジェネレータ）
についても同様に適用されます。

このステージが終わると、エンコード済みのGeneratorオブジェクトが次のステージ
であるPackagerステージに渡されます。

## 参照されているファイル

* *lib/compiler/generator.rb*: このファイルにある`encode`メソッドが
  このステージの大部分の仕事を行います。

## カスタマイズする

このステージはとてもシンプルなので、カスタマイズする必要はないでしょう。
計測等をしたくなることはあるかもしれません（例えば、プロファイリングや出力など）。
全ての段階について有効な汎用のカスタマイズ方法について詳しく知るには、
[コンパイラパイプラインのカスタマイズ](/doc/ja/bytecode-compiler/customization/)
をどうぞ。
